CATARSE.UserDocument=Backbone.View.extend({onUserDocumentKeyup:function(a){var b=$(a.currentTarget),c=b.val(),d=this.validateCpf(c),e=this.validateCnpj(c);c.replace(/[.\-\_ ]/g,"").length>10&&(d||e?(b.addClass("ok").removeClass("error"),$.post("/projects/"+this.moipForm.projectId+"/backers/"+this.moipForm.backerId+"/update_info",{backer:{payer_document:c}})):b.addClass("error").removeClass("ok"))},validateCpf:function(a){var b=0,c,d;a=a.replace(/[.\-\_ ]/g,"");var e=Math.floor(parseFloat(a)/100),f=e*100,g;for(c=0;c<=8;c++)b+=e%10*(c+2),e=Math.floor(e/10);d=b%11<2?0:11-b%11,f+=d*10,b=0,e=Math.floor(f/10);for(c=0;c<=9;c++)b+=e%10*(c+2),e=Math.floor(e/10);return d=b%11<2?0:11-b%11,f+=d,parseFloat(a)===f},validateCnpj:function(a){var b,c,d,e,f,g,h,i;i=1;if(a.length<14&&a.length<15)return!1;for(e=0;e<a.length-1;e++)if(a.charAt(e)!=a.charAt(e+1)){i=0;break}if(!i){h=a.length-2,b=a.substring(0,h),c=a.substring(h),d=0,g=h-7;for(e=h;e>=1;e--)d+=b.charAt(h-e)*g--,g<2&&(g=9);f=d%11<2?0:11-d%11;if(f!=c.charAt(0))return!1;h+=1,b=a.substring(0,h),d=0,g=h-7;for(e=h;e>=1;e--)d+=b.charAt(h-e)*g--,g<2&&(g=9);return f=d%11<2?0:11-d%11,f!=c.charAt(1)?!1:!0}return!1}}),CATARSE.MoipForm=Backbone.View.extend({el:"form.moip",getMoipToken:function(a){var b=this;$("#MoipWidget").length>0?_.isFunction(a)&&a():$.post("/payment/moip/"+this.backerId+"/get_moip_token").success(function(c,d){b.paymentChoice.$("input").attr("disabled","disabled"),c.get_token_response.status=="fail"?b.checkoutFailure({Code:0,Mensagem:c.get_token_response.message}):($("#catarse_moip_form").prepend(c.widget_tag),_.isFunction(a)&&a(c))})},checkoutFailure:function(a){this.loader.hide();var b=a.length>0?a[0]:a;b.Codigo==914&&(b.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a página</a> e repetir a operação de pagamento.'),this.message.find("p").html(b.Mensagem),this.message.fadeIn("fast"),$('input[type="submit"]').removeAttr("disabled").show()},checkoutSuccessful:function(a){var b=this;$.post("/payment/moip/"+this.backerId+"/moip_response",{response:a}).success(function(){b.loader.hide();if(a.Status=="Cancelado")return b.checkoutFailure({Codigo:0,Mensagem:a.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(a.url){var c=$('<a target="__blank">'+a.url+"</a>");c.attr("href",a.url),$(".link_content:visible").empty().html(c),$(".payment_section:visible .subtitle").fadeIn("fast")}var d=$("#project_review").data("thank-you-path");$("#payment_type_cards_section").css("display")=="block"&&(d?location.href=d:location.href="/")})},initialize:function(){this.message=this.$(".next_step_after_valid_document .alert-danger"),this.backerId=$("input#backer_id").val(),this.projectId=$("input#project_id").val(),this.loader=this.$(".loader"),this.paymentChoice=new CATARSE.PaymentChoice,this.paymentCard=new CATARSE.PaymentCard({moipForm:this}),this.paymentSlip=new CATARSE.PaymentSlip({moipForm:this}),this.paymentAccount=new CATARSE.PaymentAccount({moipForm:this}),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this)}}),CATARSE.PaymentAccount=CATARSE.UserDocument.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup"},initialize:function(a){this.moipForm=a.moipForm,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(a){var b=$(a.currentTarget).val();this.$("input#build_account_link").attr("disabled",b==""||b==undefined)},onBuildAccountClick:function(a){var b=this;a.preventDefault(),$(a.currentTarget).hide(),b.moipForm.loader.show(),b.moipForm.getMoipToken(function(){var a={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(a)})}}),CATARSE.PaymentCard=CATARSE.UserDocument.extend({el:"#payment_type_cards_section",events:{'keyup input[type="text"]':"creditCardInputValidator","keyup #payment_card_number":"onKeyupPaymentCardNumber","click input#credit_card_submit":"onSubmit","keyup #payment_card_cpf":"onUserDocumentKeyup"},initialize:function(a){this.moipForm=a.moipForm,this.$("input#payment_card_date").mask("99/99"),this.$("input#payment_card_birth").mask("99/99/9999"),this.$("input#payment_card_cpf").mask("999.999.999-99"),this.$("input#payment_card_phone").mask("(99) 9999-9999?9")},onKeyupPaymentCardNumber:function(a){this.$("input#payment_card_flag").val(this.getCardFlag($(a.currentTarget).val()))},onSubmit:function(a){var b=this;a.preventDefault(),$(a.currentTarget).hide(),b.moipForm.loader.show(),b.moipForm.getMoipToken(function(){var a={Forma:"CartaoCredito",Instituicao:b.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:b.$("input#payment_card_number").val(),Expiracao:b.$("input#payment_card_date").val(),CodigoSeguranca:b.$("input#payment_card_source").val(),Portador:{Nome:b.$("input#payment_card_name").val(),DataNascimento:b.$("input#payment_card_birth").val(),Telefone:b.$("input#payment_card_phone").val(),Identidade:b.$("input#payment_card_cpf").val()}}};MoipWidget(a)})},hasContent:function(a){var b=$(a).val().replace(/[\-\.\_\/\s]/g,"");return b&&b.length>0?($(a).addClass("ok").removeClass("error"),!0):($(a).addClass("error").removeClass("ok"),!1)},creditCardInputValidator:function(){var a=this,b=!0;$.each($('#payment_type_cards_section input[type="text"]'),function(c,d){b=a.hasContent(d)}),$("input#credit_card_submit").attr("disabled",!b)},getCardFlag:function(a){var b=(a+"").replace(/\s/g,"");return/^(34|37)/.test(b)&&b.length==15?"AmericanExpress":/^(51|52|53|54|55)/.test(b)&&b.length==16?"Mastercard":!/^(4)/.test(b)||b.length!=13&&b.length!=16?/^(300|301|302|303|304|305|36|38)/.test(b)&&b.length==14?"Diners":/^(38)/.test(b)&&b.length==19?"Hipercard":"Desconhecido":"Visa"}}),CATARSE.PaymentChoice=Backbone.View.extend({el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(a){$(".payment_section").fadeOut("fast",function(){var b=$(a.currentTarget).attr("id");$("#"+b+"_section").fadeIn("fast")})},initialize:function(){this.$("input#payment_type_cards").click()}}),CATARSE.PaymentSlip=CATARSE.UserDocument.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","keyup #user_document_payment_slip":"onUserDocumentPaymentSlipKeyup"},onUserDocumentPaymentSlipKeyup:function(a){var b=$(a.currentTarget);this.onUserDocumentKeyup(a),$("input#build_boleto").attr("disabled",!b.hasClass("ok"))},initialize:function(a){this.moipForm=a.moipForm,this.$("input#user_document_payment_slip").mask("999.999.999-99")},onBuildBoletoClick:function(a){var b=this;a.preventDefault(),$(a.currentTarget).hide(),b.moipForm.loader.show(),b.moipForm.getMoipToken(function(){var a={Forma:"BoletoBancario"};MoipWidget(a)})},onContentClick:function(a){window.setTimeout(function(){location.href="/thank_you";var a=$("#project_review").data("thank-you-path");a?location.href=a:location.href="/"},1e3)}}),$(function(){var a=window.moipForm=new CATARSE.MoipForm})